{"ast":null,"code":"import _classCallCheck from\"/Users/eren_kafadar/Documents/eren_kafadar/LAB/per_rf/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/eren_kafadar/Documents/eren_kafadar/LAB/per_rf/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _possibleConstructorReturn from\"/Users/eren_kafadar/Documents/eren_kafadar/LAB/per_rf/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";import _getPrototypeOf from\"/Users/eren_kafadar/Documents/eren_kafadar/LAB/per_rf/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";import _inherits from\"/Users/eren_kafadar/Documents/eren_kafadar/LAB/per_rf/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import React,{Component}from'react';import{aws_saveTaskData,aws_fetchLink}from\"../lib/aws_lambda\";import{isLocalhost}from\"../lib/utils\";import'../lib/external/lab.css';import'./LabJsWrapper.css';var config=require('../config');var _=require('lodash');var qs=require('query-string');require('jquery');var LabJsWrapper=/*#__PURE__*/function(_Component){_inherits(LabJsWrapper,_Component);function LabJsWrapper(props){var _this;_classCallCheck(this,LabJsWrapper);_this=_possibleConstructorReturn(this,_getPrototypeOf(LabJsWrapper).call(this,props));// Parse get params for encrypted metadata\nvar params=qs.parse(_this.props.location.search,{ignoreQueryPrefix:true});// Set init state\n_this.state={encryptedMetadata:params.id,sendingData:false,link:undefined};_this.surveyUrl=params.survey_url;console.log(process.env.PUBLIC_URL);if(!_.isUndefined(_this.state.encryptedMetadata)){_this.addScript(\"module\",process.env.PUBLIC_URL+'/lib/lab.js',function(){_this.addScript(\"application/javascript\",process.env.PUBLIC_URL+'/trials.js',function(){_this.addScript(\"module\",process.env.PUBLIC_URL+'/script.js');});});}return _this;}// labJsData should be parsed\n_createClass(LabJsWrapper,[{key:\"packageDataForExport\",value:function packageDataForExport(labJsData){var exportData={};exportData.encrypted_metadata=this.state.encryptedMetadata;exportData.taskName=config.taskName;exportData.taskVersion=config.taskVersion;exportData.data=this.processLabJsData(labJsData);return JSON.stringify(exportData);}},{key:\"processLabJsData\",value:function processLabJsData(labJsData){var processedData=[];// Always keep entry 0 of labjs data since it contains useful metadata\nprocessedData.push(labJsData[0]);// The last frame contains all collected data\nvar data=labJsData[labJsData.length-1].finalData;console.log(data);processedData.push(data);return processedData;}},{key:\"componentDidMount\",value:function componentDidMount(){var that=this;window.addEventListener('message',function(event){if(event.data.type==='labjs.data'){var parsedData=JSON.parse(event.data.json);// Print out debugging info if flag is set or we're on localhost\nif(config.debug||isLocalhost){console.log(parsedData);console.log(that.packageDataForExport(parsedData));}if(isLocalhost){if(that.surveyUrl){that.setState({link:that.surveyUrl});}return;}that.setState({sendingData:true});aws_saveTaskData(that.state.encryptedMetadata,that.packageDataForExport(parsedData)).then(function(){if(that.surveyUrl){that.setState({link:that.surveyUrl});}else{aws_fetchLink(that.state.encryptedMetadata).then(function(link){return that.setState({link:link});});}});}});}},{key:\"addScript\",value:function addScript(type,src,callback){var script=document.createElement(\"script\");script.src=src;script.type=type;script.onreadystatechange=callback;script.onload=callback;document.head.appendChild(script);}},{key:\"render\",value:function render(){if(_.isUndefined(this.state.encryptedMetadata)){return React.createElement(\"div\",null,React.createElement(\"h2\",null,\"Something went wrong. Please try again.\"));}else if(!_.isUndefined(this.state.link)){window.location.assign(this.state.link);}return React.createElement(\"div\",null,React.createElement(\"div\",{id:\"experiment\",className:\"container fullscreen\",\"data-labjs-section\":\"main\",style:{visibility:this.state.sendingData?'hidden':'visible'}},React.createElement(\"main\",{className:\"content-vertical-center content-horizontal-center\"},React.createElement(\"div\",null,React.createElement(\"h2\",null,\"Loading Experiment\"),React.createElement(\"p\",null,\"The experiment is loading and should start in a few seconds\")))),React.createElement(\"div\",{className:\"center\",style:{visibility:this.state.sendingData?'visible':'hidden'}},React.createElement(\"h2\",null,\"Saving data... do not exit window\")),React.createElement(\"footer\",{className:\"content-vertical-center content-horizontal-center\"}))// </div>\n;}// end render\n}]);return LabJsWrapper;}(Component);// end class\nexport default LabJsWrapper;","map":{"version":3,"sources":["/Users/eren_kafadar/Documents/eren_kafadar/LAB/per_rf/src/containers/LabJsWrapper.js"],"names":["React","Component","aws_saveTaskData","aws_fetchLink","isLocalhost","config","require","_","qs","LabJsWrapper","props","params","parse","location","search","ignoreQueryPrefix","state","encryptedMetadata","id","sendingData","link","undefined","surveyUrl","survey_url","console","log","process","env","PUBLIC_URL","isUndefined","addScript","labJsData","exportData","encrypted_metadata","taskName","taskVersion","data","processLabJsData","JSON","stringify","processedData","push","length","finalData","that","window","addEventListener","event","type","parsedData","json","debug","packageDataForExport","setState","then","src","callback","script","document","createElement","onreadystatechange","onload","head","appendChild","assign","visibility"],"mappings":"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","sourcesContent":["import React, {Component} from 'react';\nimport {aws_saveTaskData, aws_fetchLink} from \"../lib/aws_lambda\";\nimport {isLocalhost} from \"../lib/utils\";\n\nimport '../lib/external/lab.css';\nimport './LabJsWrapper.css';\n\nconst config = require('../config');\nvar _ = require('lodash');\nvar qs = require('query-string');\nrequire('jquery');\n\n\nclass LabJsWrapper extends Component {\n  constructor(props) {\n    super(props);\n\n    // Parse get params for encrypted metadata\n    const params = qs.parse(\n      this.props.location.search,\n      {ignoreQueryPrefix: true}\n    );\n\n    // Set init state\n    this.state = {\n      encryptedMetadata: params.id,\n      sendingData: false,\n      link: undefined,\n    };\n\n      this.surveyUrl = params.survey_url;\n\n      console.log(process.env.PUBLIC_URL);\n      if (!_.isUndefined(this.state.encryptedMetadata)) {\n        this.addScript(\"module\", process.env.PUBLIC_URL + '/lib/lab.js', () => {\n          this.addScript(\"application/javascript\", process.env.PUBLIC_URL + '/trials.js', () => {\n            this.addScript(\"module\", process.env.PUBLIC_URL + '/script.js');\n          });\n        });\n      }\n  }\n\n  // labJsData should be parsed\n  packageDataForExport(labJsData) {\n    const exportData = {};\n\n    exportData.encrypted_metadata = this.state.encryptedMetadata;\n    exportData.taskName = config.taskName;\n    exportData.taskVersion = config.taskVersion;\n    exportData.data = this.processLabJsData(labJsData);\n\n    return JSON.stringify(exportData);\n  }\n\n  processLabJsData(labJsData) {\n    const processedData = [];\n\n    // Always keep entry 0 of labjs data since it contains useful metadata\n    processedData.push(labJsData[0]);\n\n    // The last frame contains all collected data\n    const data = labJsData[labJsData.length - 1].finalData;\n    console.log(data);\n    processedData.push(data);\n\n    return processedData;\n  }\n\n  componentDidMount() {\n    var that = this;\n    window.addEventListener('message', function(event) {\n      if (event.data.type === 'labjs.data') {\n        const parsedData = JSON.parse(event.data.json);\n\n        // Print out debugging info if flag is set or we're on localhost\n        if (config.debug || isLocalhost) {\n          console.log(parsedData);\n          console.log(that.packageDataForExport(parsedData));\n        }\n\n        if (isLocalhost) {\n          if (that.surveyUrl) {\n            that.setState({link: that.surveyUrl});\n          }\n          return;\n        }\n\n        that.setState({sendingData: true});\n        aws_saveTaskData(that.state.encryptedMetadata, that.packageDataForExport(parsedData)).then(\n          () => {\n            if (that.surveyUrl) {\n              that.setState({link: that.surveyUrl});\n            } else {\n              aws_fetchLink(that.state.encryptedMetadata).then(\n                (link) => that.setState({link: link})\n              );\n            }\n          }\n        );\n      }\n    });\n\n  }\n\n    addScript(type, src, callback) {\n    const script = document.createElement(\"script\");\n    script.src = src;\n    script.type = type;\n    script.onreadystatechange = callback;\n    script.onload = callback;\n\n    document.head.appendChild(script);\n  }\n\n  render() {\n    if (_.isUndefined(this.state.encryptedMetadata)) {\n      return (\n        <div>\n          <h2>Something went wrong. Please try again.</h2>\n        </div>\n      );\n    } else if (!_.isUndefined(this.state.link)) {\n      window.location.assign(this.state.link);\n    }\n\n      return (\n              <div>\n              <div id=\"experiment\" className=\"container fullscreen\" data-labjs-section=\"main\" style={{visibility: this.state.sendingData ? 'hidden' : 'visible'}}>\n                  <main className=\"content-vertical-center content-horizontal-center\">\n                      <div>\n                          <h2>Loading Experiment</h2>\n                          <p>The experiment is loading and should start in a few seconds</p>\n                      </div>\n                  </main>\n              </div>\n              <div className=\"center\" style={{visibility: this.state.sendingData ? 'visible' : 'hidden'}}>\n              <h2>Saving data... do not exit window</h2>\n              </div>\n              <footer className=\"content-vertical-center content-horizontal-center\">\n              </footer>\n              </div>\n              // </div>\n    );\n  } // end render\n} // end class\n\nexport default LabJsWrapper;\n"]},"metadata":{},"sourceType":"module"}